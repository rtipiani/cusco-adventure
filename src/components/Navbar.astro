---
type Lang = "es" | "en";

interface MenuItem {
    label: string;
    href?: string;
    children?: { label: string; href: string }[];
}

const menuItems: Record<Lang, MenuItem[]> = {
    es: [
        { label: "Inicio", href: "/es" },
        {
            label: "Paquetes Cusco / Machu Picchu",
            children: [
                { label: "Cusco Tradicional 3D/2N", href: "/es/cusco-tradicional-3d-2n" },
                { label: "Cusco Sagrado 4D/3N", href: "/es/cusco-sagrado-4d-3n" },
                { label: "Cusco Increíble 5D/4N", href: "/es/cusco-increible-5d-4n" },
                { label: "Cusco Maravilloso 6D/5N", href: "/es/cusco-maravilloso-6d-5n" },
                { label: "Cusco Sorprendente 7D/6N", href: "/es/cusco-sorprendente-7d-6n" },
                { label: "Cusco Extraordinario 8D/7N", href: "/es/cusco-extraordinario-8d-7n" },
            ],
        },
        {
            label: "Destinos Perú",
            children: [
                { label: "Tours en Cusco", href: "/es/cusco" },
                { label: "Tours en Lima", href: "/es/lima" },
                { label: "Tours en Puno", href: "/es/puno" },
                { label: "Tours en Ica", href: "/es/ica" },
                { label: "Tours en Arequipa", href: "/es/arequipa" },
                { label: "Tours en Puerto Maldonado", href: "/es/puerto-maldonado" }
            ],
        },
        { 
            label: "Nosotros", 
            children: [
                { label: "Nosotros", href: "/es/nosotros" },
                { label: "Contáctanos", href: "/es/contactanos" }
            ]
        },
        { label: "Galería", href: "/es/galeria" }
    ],
    en: [
        { label: "Home", href: "/en" },
        {
            label: "Cusco / Machu Picchu Packages",
            children: [
                { label: "Traditional Cusco 3D/2N", href: "/en/traditional-cusco-3d-2n" },
                { label: "Sacred Cusco 4D/3N", href: "/en/sacred-cusco-4d-3n" },
                { label: "Incredible Cusco 5D/4N", href: "/en/incredible-cusco-5d-4n" },
                { label: "Marvelous Cusco 6D/5N", href: "/en/marvelous-cusco-6d-5n" },
                { label: "Amazing Cusco 7D/6N", href: "/en/amazing-cusco-7d-6n" },
                { label: "Extraordinary Cusco 8D/7N", href: "/en/extraordinary-cusco-8d-7n" }
            ],
        },
        {
            label: "Peru Destinations",
            children: [
                { label: "Tours in Cusco", href: "/en/cusco" },
                { label: "Tours in Lima", href: "/en/lima" },
                { label: "Tours in Puno", href: "/en/puno" },
                { label: "Tours in Ica", href: "/en/ica" },
                { label: "Tours in Arequipa", href: "/en/arequipa" },
                { label: "Tours in Puerto Maldonado", href: "/en/puerto-maldonado" },
            ],
        },
        { 
            label: "About Us",
            children: [
                { label: "About-Us", href: "/en/about-us" },
                { label: "Contact-Us", href: "/en/contact-us" }
            ]
        },
        { label: "Gallery", href: "/en/gallery" }
    ],
};

const path = Astro.url.pathname;

function normalizeHref(h?: string) {
    if (!h) return "";
    let s = h.replace(/^\.\//, "/");
    if (!s.startsWith("/")) s = "/" + s;
    if (s !== "/" && s.endsWith("/")) s = s.replace(/\/+$/, "");
    return s;
}
const pathNorm = (path && path.replace(/\/+$/, "")) || "/";

function hrefMatches(h?: string) {
    if (!h) return false;
    const nh = normalizeHref(h);
    if (!nh) return false;

    if (nh === "/es" || nh === "/en") {
        return pathNorm === nh;
    }

    return pathNorm === nh || pathNorm.startsWith(nh + "/");
}

const routes: Record<string, { es: string; en: string }> = {
    "/es": { es: "/es", en: "/en" },

    "/es/cusco-tradicional-3d-2n": { es: "/es/cusco-tradicional-3d-2n", en: "/en/traditional-cusco-3d-2n" },
    "/en/traditional-cusco-3d-2n": { en: "/en/traditional-cusco-3d-2n", es: "/es/cusco-tradicional-3d-2n" },

    "/es/cusco-sagrado-4d-3n": { es: "/es/cusco-sagrado-4d-3n", en: "/en/sacred-cusco-4d-3n" },
    "/en/sacred-cusco-4d-3n": { en: "/en/sacred-cusco-4d-3n", es: "/es/cusco-sagrado-4d-3n" },

    "/es/cusco-increible-5d-4n": { es: "/es/cusco-increible-5d-4n", en: "/en/incredible-cusco-5d-4n" },
    "/en/incredible-cusco-5d-4n": { en: "/en/incredible-cusco-5d-4n", es: "/es/cusco-increible-5d-4n" },

    "/es/cusco-maravilloso-6d-5n": { es: "/es/cusco-maravilloso-6d-5n", en: "/en/marvelous-cusco-6d-5n" },
    "/en/marvelous-cusco-6d-5n": { en: "/en/marvelous-cusco-6d-5n", es: "/es/cusco-maravilloso-6d-5n" },

    "/es/cusco-sorprendente-7d-6n": { es: "/es/cusco-sorprendente-7d-6n", en: "/en/amazing-cusco-7d-6n" },
    "/en/amazing-cusco-7d-6n": { en: "/en/amazing-cusco-7d-6n", es: "/es/cusco-sorprendente-7d-6n" },

    "/es/cusco-extraordinario-8d-7n": { es: "/es/cusco-extraordinario-8d-7n", en: "/en/extraordinary-cusco-8d-7n" },
    "/en/extraordinary-cusco-8d-7n": { en: "/en/extraordinary-cusco-8d-7n", es: "/es/cusco-extraordinario-8d-7n" },

    "/es/cusco": { es: "/es/cusco", en: "/en/cusco" },
    "/en/cusco": { en: "/en/cusco", es: "/es/cusco" },

    "/es/lima": { es: "/es/lima", en: "/en/lima" },
    "/en/lima": { en: "/en/lima", es: "/es/lima" },

    "/es/puno": { es: "/es/puno", en: "/en/puno" },
    "/en/puno": { en: "/en/puno", es: "/es/puno" },

    "/es/ica": { es: "/es/ica", en: "/en/ica" },
    "/en/ica": { en: "/en/ica", es: "/es/ica" },

    "/es/arequipa": { es: "/es/arequipa", en: "/en/arequipa" },
    "/en/arequipa": { en: "/en/arequipa", es: "/es/arequipa" },

    "/es/puerto-maldonado": { es: "/es/puerto-maldonado", en: "/en/puerto-maldonado" },
    "/en/puerto-maldonado": { en: "/en/puerto-maldonado", es: "/es/puerto-maldonado" },

    "/es/nosotros": { es: "/es/nosotros", en: "/en/about-us" },
    "/en/about-us": { en: "/en/about-us", es: "/es/nosotros" },

    "/es/galeria": { es: "/es/galeria", en: "/en/gallery" },
    "/en/gallery": { en: "/en/gallery", es: "/es/galeria" },

    "/es/contactanos": { es: "/es/contactanos", en: "/en/contact-us" },
    "/en/contact-us": { en: "/en/contact-us", es: "/es/contactanos" },

    "/es/terminos-y-condiciones": { es: "/es/terminos-y-condiciones", en: "/en/terms-and-conditions" },
    "/en/terms-and-conditions": { en: "/en/terms-and-conditions", es: "/es/terminos-y-condiciones" },

    "/es/politicas-de-privacidad": { es: "/es/politicas-de-privacidad", en: "/en/privacy-policy" },
    "/en/privacy-policy": { en: "/en/privacy-policy", es: "/es/politicas-de-privacidad" },

    "/es/codigo-esnna": { es: "/es/codigo-esnna", en: "/en/esnna-code" },
    "/en/esnna-code": { en: "/en/esnna-code", es: "/es/codigo-esnna" },
    
    "/es/libro-de-reclamaciones": { es: "/es/libro-de-reclamaciones", en: "/en/virtual-complaints-book" },
    "/en/virtual-complaints-book": { en: "/en/virtual-complaints-book", es: "/es/libro-de-reclamaciones" },
};

function computeLangToggleHref(p: string, lang: Lang) {
    const cleanPath = (p && p.replace(/\/+$/, "")) || "/";
    const match = routes[cleanPath];
    if (match) return match[lang];

    if (lang === "en") {
        return cleanPath.startsWith("/es")
            ? cleanPath.replace(/^\/es/, "/en")
            : "/en";
    } else {
        return cleanPath.startsWith("/en")
            ? cleanPath.replace(/^\/en/, "/es")
            : "/es";
    }
}

const currentLang: Lang = path.startsWith("/en") ? "en" : "es";
const targetLang: Lang = currentLang === "es" ? "en" : "es";
const langToggleHref = computeLangToggleHref(path, targetLang);
---
<nav id="navbar" class="fixed top-0 left-0 w-full bg-[#64a323]/20 backdrop-blur-md border-b border-[#64a323]/30 z-50 transition-colors duration-500 ease-in-out">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">

            <a href={menuItems[currentLang][0].href} class="flex items-center group">
                <img src="/logo.avif" alt="Cusco Adventure Travel Perú" class="h-12 w-auto transition-transform duration-300 group-hover:scale-105"/>
                <div class="flex flex-col justify-center leading-none ml-1 logo-text">
                    <span class="font-bold text-lg sm:text-xl leading-none text-[#efe7da] group-hover:text-[#ffc834] transition-colors">
                        Cusco Adventure
                    </span>
                    <span class="text-sm sm:text-base tracking-wide leading-none text-[#efe7da] group-hover:text-[#ffc834] transition-colors">
                        Travel Peru
                    </span>
                </div>
            </a>

            <div class="hidden xl:flex items-center space-x-8">
                {menuItems[currentLang].map(({ label, href, children }) => {
                    const isParentActive = children ? children.some(c => hrefMatches(c.href)) : href && hrefMatches(href);
                    return children ? (
                        <div class="relative group">
                            <button class={`nav-link ${isParentActive ? "nav-active text-[#ffc834] bg-[#19470c] px-2 py-1 rounded-md" : "hover:text-[#fcd875]"} flex items-center space-x-1 font-semibold tracking-wide transition-all duration-300`} type="button">
                                <span>{label}</span>
                                <i class="fas fa-chevron-down text-xs transition-transform duration-300 group-hover:rotate-180"></i>
                            </button>

                            <div class="absolute left-0 mt-3 w-60 bg-[#19470c]/90 backdrop-blur-lg rounded-xl shadow-xl border border-[#64a323]/30 opacity-0 invisible group-hover:opacity-100 group-hover:visible group-hover:translate-y-1 transition-all duration-300 z-50">
                                {children.map((sub) => {
                                    const isChildActive = hrefMatches(sub.href);
                                    return (
                                        <a 
                                            href={sub.href} 
                                            class={`block px-5 py-3 font-medium rounded-lg transition-all duration-200 ${isChildActive ? "bg-[#efe7da] text-[#64a323] font-bold" : "text-[#efe7da] hover:bg-[#64a323]/40 hover:text-[#ffc834]"}`}
                                            aria-current={isChildActive ? "page" : null}
                                        >
                                            {sub.label}
                                        </a>
                                    );
                                })}
                            </div>
                        </div>
                    ) : (
                        (() => {
                            const isActive = href && hrefMatches(href);
                            return (
                                <a 
                                  href={href} 
                                  class={`nav-link ${isActive ? "nav-active text-[#ffc834]" : "hover:text-[#fcd875]"} relative font-semibold tracking-wide transition-all duration-300`}
                                  aria-current={isActive ? "page" : null}
                                >
                                  {label}
                                </a>
                            );
                        })()
                    );
                })}
            </div>

            <div class="hidden xl:flex items-center space-x-4">
                <a href={langToggleHref} class="nav-link px-3 py-1 border border-[#ffc834] rounded-lg hover:bg-[#ffc834] hover:text-[#19470c] transition flex items-center space-x-2 shadow-sm">
                    <img src={currentLang === "es" ? "/flags/eu.avif" : "/flags/pe.avif"} alt={currentLang === "es" ? "English" : "Español"} class="h-5 w-5"/>
                    <span class="font-bold">{currentLang === "es" ? "EN" : "ES"}</span>
                </a>
            </div>

            <button id="menu-button" type="button" class="xl:hidden inline-flex items-center justify-center p-2 rounded-md nav-link hover:bg-[#64a323]/80 focus:outline-none" aria-controls="mobile-menu" aria-expanded="false">
                <svg id="menu-icon" class="h-6 w-6 transition-colors duration-300" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M4 6h16M4 12h16M4 18h16"/>
                </svg>
                <span class="sr-only">Abrir menú</span>
            </button>
        </div>
    </div>

    <div id="mobile-menu" class="hidden xl:hidden flex-col px-4 pb-4 space-y-3 bg-gray-800 backdrop-blur-lg border-t border-[#64a323]/30 shadow-inner text-left">
        {menuItems[currentLang].map(({ label, href, children }) => {
            const isParentActive = children ? children.some(c => hrefMatches(c.href)) : href && hrefMatches(href);
            return children ? (
                <div class="border-b border-[#64a323]/30">
                    <button 
                      class={`w-full flex justify-between items-center py-3 font-semibold rounded-lg transition-all duration-300 ${isParentActive ? "text-[#ffc834] bg-[#64a323]/20" : "text-[#efe7da] hover:text-[#ffc834]"}`}
                      onclick="this.querySelector('i').classList.toggle('rotate-180'); this.nextElementSibling.classList.toggle('hidden')"
                      aria-expanded={isParentActive ? "true" : "false"}
                      type="button"
                    >
                        <span>{label}</span>
                        <i class={`fas fa-chevron-down transition-transform duration-300 ${isParentActive ? "rotate-180" : ""}`}></i>
                    </button>

                    <div class={`flex-col pl-4 pb-2 ${isParentActive ? "flex" : "hidden"}`}>
                        {children.map((sub) => {
                            const isChildActive = hrefMatches(sub.href);
                            return (
                                <a 
                                  href={sub.href} 
                                  class={`block py-2 transition ${isChildActive ? "text-[#ffc834] font-bold" : "text-[#efe7da] hover:text-[#ffc834]"}`}
                                  aria-current={isChildActive ? "page" : null}
                                >
                                    {sub.label}
                                </a>
                            );
                        })}
                    </div>
                </div>
            ) : (
                <a 
                  href={href} 
                  class={`block py-3 font-semibold border-b transition ${href && hrefMatches(href) ? "text-[#ffc834]" : "text-[#efe7da] hover:text-[#ffc834]"}`}
                  aria-current={href && hrefMatches(href) ? "page" : null}
                >
                  {label}
                </a>
            );
        })}

        <a href={langToggleHref} class="mt-3 inline-flex w-max mx-auto items-center space-x-2 px-4 py-2 text-[#efe7da] border border-[#efe7da] rounded-lg hover:bg-[#efe7da] hover:text-gray-800 transition-all shadow-sm font-bold">
            <span>{currentLang === "es" ? "🇬🇧" : "🇪🇸"}</span>
            <span>{currentLang === "es" ? "EN" : "ES"}</span>
        </a>
    </div>
</nav>

<script is:inline>
    const navbar = document.getElementById("navbar");
    const btn = document.getElementById("menu-button");
    const mobileMenu = document.getElementById("mobile-menu");
    const navLinks = document.querySelectorAll(".nav-link");
    const logoText = document.querySelectorAll(".logo-text span");
    const menuIcon = document.getElementById("menu-icon");

    function updateNavbar() {
        const scrolled = window.scrollY > 50;

        navbar.classList.toggle("nav-scrolled", scrolled);

        navLinks.forEach(link => {
            if (link.classList.contains("nav-active")) return;

            if (scrolled) {
                link.classList.remove("text-white");
                link.classList.add("text-gray-800");
                link.classList.add("hover:bg-[#fcd875]/20");
                menuIcon.classList.remove('text-white');
                menuIcon.classList.add("text-gray-800");
            } else {
                link.classList.remove("text-gray-800");
                link.classList.add("text-white");
                link.classList.add("hover:bg-[#fcd875]/20");
                menuIcon.classList.remove("text-gray-800");
                menuIcon.classList.add("text-white");
            }
        });

        logoText.forEach(span => {
            span.classList.toggle("text-gray-800", scrolled);
            span.classList.toggle("text-white", !scrolled);
        });
    }

    window.addEventListener("scroll", updateNavbar);
    updateNavbar();

    if (btn && mobileMenu) {
        btn.addEventListener("click", () => {
            const isHidden = mobileMenu.classList.contains("hidden");

            mobileMenu.classList.toggle("hidden", !isHidden);
            mobileMenu.classList.toggle("flex", isHidden);
            btn.setAttribute("aria-expanded", isHidden.toString());

            // Bloquear scroll del body cuando el menú esté abierto
            if (isHidden) {
            document.body.classList.add("overflow-hidden");
            } else {
            document.body.classList.remove("overflow-hidden");
            }
        });

        // Al hacer clic en un link, cerrar menú y restaurar scroll
        mobileMenu.querySelectorAll("a").forEach((link) => {
            link.addEventListener("click", () => {
            mobileMenu.classList.add("hidden");
            mobileMenu.classList.remove("flex");
            btn.setAttribute("aria-expanded", "false");
            document.body.classList.remove("overflow-hidden");
            });
        });
    }
</script>